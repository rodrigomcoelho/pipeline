name: New Deploy DAGs to Composer
on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
jobs:
  deploy:
    name: Upload DAG files to Airflow
    runs-on: ubuntu-latest
    steps:
      # copying files to machine
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Check if there is changed files
        id: changed-files
        run: |
          echo "all_changed_files=$(git diff @~..@ --name-only --no-renames | sort)" >> $GITHUB_OUTPUT
          if -z $FILE_CHANGED;
          then
            echo "any_change=true" >> $GITHUB_OUTPUT
            echo "modified_files=$(git diff @~..@ --name-only --no-renames --name-status=ACM | sort)" >> $GITHUB_OUTPUT
            echo "deleted_files=$(git diff @~..@ --name-only --no-renames --name-status=RD | sort)" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # listing changed files
      - name: List all changed files
        if: steps.changed-files.outputs.any_change == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.deleted_files }}; do
            echo "$file has been deleted."
          done
          for file in ${{ steps.changed-files.outputs.modified_files }}; do
            echo "$file has been either added or modified."
          done

      - name: Applying changes to composer
        if: steps.changed-files.outputs.any_change == 'true'
        run: |
          brach=$(echo ${{ github.ref }} | sed 's/refs\/heads\///g')
          destination=gs://composer-dev-bucket/dags/data_eng_fis_cliente/"

          echo '
          argo submit -n argo -w deploy/deploy-data-gcp.yml \
            --parameter "file_changed=${{ steps.changed-files.outputs.modified_files }}" \
            --parameter "file_deleted=${{ steps.changed-files.outputs.deleted_files }}" \
            --parameter "bucket_path=$destination" \
            --parameter "branch=$brach"
          '
